#!/usr/bin/env bash

apiurl="https://api.github.com/users/{username}/repos?type=owner&sort=pushed"

# curl options
copts=(-sSL)

# log <arg>... | echo args to STDERR
log() {
  echo "$@" >&2
}

# fatal <msg> | Print error message & usage and exit
fatal() {
  log "ERROR: $1"
  usage
  exit 1
}

usage() {
    cat <<EOS
Usage: github-repos [options] <username>

Fetch JSON list of user's repos from GitHub API.

If the environment variables GITHUB_API_TOKEN and
GITHUB_USERNAME are set, those credentials are
used to access the GitHub API.

Options:
    -h      Show this help message and exit
EOS
}

while getopts ":h" opt; do
  case $opt in
    h)
      usage
      exit 0
      ;;
    \?)
      log "Invalid option: -$OPTARG"
      exit 1
      ;;
  esac
done
shift $((OPTIND-1))

username="$1"

# Exit if no username was given
test -n "$username" || fatal "No username given"

test -n "$GITHUB_API_TOKEN" && test -n "$GITHUB_USERNAME" && {
  log "Using API token from environment"
  apikey="$GITHUB_API_TOKEN"
  copts+=(-u "$GITHUB_USERNAME:$GITHUB_API_TOKEN")
}


log "Fetching repos for $username ..."

url="$( echo "$apiurl" | sed -e "s/{username}/${username}/g" )"

curl ${copts[@]} "$url"
exit $?
